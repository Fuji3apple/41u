<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densityDpi=device-dpi" /> 
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/n5ro/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/jsm/loaders/DRACOLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/jsm/loaders/GLTFLoader.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        id="scene"
        embedded
        physics="gravity: -9.8"
    >
        <a-assets>
            <a-asset-item
                id="animated-asset"
                src="assets/asset!.glb"
            ></a-asset-item>
        </a-assets>

        <a-marker
            id="animated-marker"
            type="pattern"
            preset="custom"
            url="assets/marker.patt"
        >
            <!-- 下限 -->
            <a-entity
                id="floor"
                position="0 0 0"
                geometry="primitive: box; width: 3; height: 0.1; depth: 3"
                material="opacity: 0; transparent: true"
                static-body
            ></a-entity>

            <a-entity id="model-container"></a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // 生成間隔 
        const spawnInterval = 500;
        const maxModels = 25; // 最大モデル
        let modelCount = 0;

        function spawnModel() {
            const sceneEl = document.querySelector("#model-container");
            if (modelCount >= maxModels) return;

            const newModel = document.createElement("a-entity");
            newModel.setAttribute("gltf-model", "#animated-asset");

            // 生成位置とモデル設定
            newModel.setAttribute("position", `0 5 0`);
            newModel.setAttribute("scale", "0.3 0.3 0.3");

            newModel.setAttribute("dynamic-body", "mass: 0.5; linearDamping: 0.1; angularDamping: 0.1;");

            // モデルの削除
            newModel.addEventListener("collide", (e) => {
                if (e.detail.body.el.id === "floor") {
                    setTimeout(() => {
                        if (sceneEl.contains(newModel)) {
                            sceneEl.removeChild(newModel);
                            modelCount--;
                        }
                    }, 1000); // 一定時間後にモデルを削除
                }
            });

            sceneEl.appendChild(newModel);
            modelCount++;
        }

        // 一定間隔でモデルを生成
        setInterval(spawnModel, spawnInterval);
    </script>
</body>
</html>
